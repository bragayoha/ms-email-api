"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Hash_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Hash"));
const Database_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Lucid/Database"));
const Role_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Role"));
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
const sendMail_1 = global[Symbol.for('ioc.use')]("App/Services/sendMail");
const AccessAllowValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/AccessAllowValidator"));
const CreateUserValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/CreateUserValidator"));
const ResetPasswordValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/ResetPasswordValidator"));
const UpdateUserValidator_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Validators/UpdateUserValidator"));
const dayjs_1 = __importDefault(require("dayjs"));
class UsersController {
    async index({ request, response }) {
        const { page, perPage, noPaginate } = request.qs();
        if (noPaginate) {
            return User_1.default.query().preload('roles', (roleTable) => {
                roleTable.select('id', 'name');
            });
        }
        try {
            const users = await User_1.default.query()
                .preload('roles', (roleTable) => {
                roleTable.select('id', 'name');
            })
                .paginate(page || 1, perPage || 10);
            return response.ok(users);
        }
        catch (error) {
            return response.badRequest({ message: 'Error in list users', originalError: error.message });
        }
    }
    async store({ response, request }) {
        const data = await request.validate(CreateUserValidator_1.default);
        let user;
        const trx = await Database_1.default.transaction();
        try {
            user = await User_1.default.create({
                name: data.name,
                cpf: data.cpf,
                email: data.email,
                password: data.password,
            }, trx);
            const rolePlayer = await Role_1.default.findBy('name', 'player');
            if (rolePlayer)
                await user.related('roles').attach([rolePlayer.id]);
        }
        catch (error) {
            trx.rollback();
            return response.badRequest({ message: 'Error in create user', originalError: error.message });
        }
        let userFind;
        try {
            userFind = await User_1.default.query().where('id', user.id).preload('roles');
        }
        catch (error) {
            trx.rollback();
            return response.badRequest({ message: 'Error in find user', originalError: error.message });
        }
        try {
            await (0, sendMail_1.sendMail)(user, 'Welcome to the Best Lottery System!', 'send_welcome_email');
        }
        catch (error) {
            trx.rollback();
            return response.badRequest({
                message: 'Error in send welcome email',
                originalError: error.message,
            });
        }
        trx.commit();
        return response.ok({ userFind });
    }
    async show({ response, params }) {
        const userSecureId = params.id;
        try {
            const user = await User_1.default.query()
                .where('secure_id', userSecureId)
                .preload('roles')
                .preload('bets', (bet) => {
                const currentDateLess30days = (0, dayjs_1.default)().subtract(30, 'd').format();
                bet.where('created_at', '>', currentDateLess30days);
            });
            return response.ok(user);
        }
        catch (error) {
            return response.notFound({ message: 'User not found', originalError: error.message });
        }
    }
    async update({ request, response, params }) {
        const data = await request.validate(UpdateUserValidator_1.default);
        const userSecureId = params.id;
        let user;
        const trx = await Database_1.default.transaction();
        try {
            user = await User_1.default.findByOrFail('secure_id', userSecureId);
            user.merge({ name: data.name, cpf: data.cpf, email: data.email }, trx).save();
        }
        catch (error) {
            trx.rollback();
            return response.badRequest({ message: 'Error in update user', originalError: error.message });
        }
        let userFind;
        try {
            userFind = await User_1.default.query().where('id', user.id).preload('roles');
        }
        catch (error) {
            trx.rollback();
            return response.badRequest({ message: 'Error in find user', originalError: error.message });
        }
        trx.commit();
        return response.ok({ userFind });
    }
    async destroy({ response, params }) {
        const userSecureId = params.id;
        try {
            const user = await User_1.default.findByOrFail('secure_id', userSecureId);
            await user.delete();
            return response.ok({ message: 'Success in delete user' });
        }
        catch (error) {
            return response.notFound({ message: 'User not found', originalError: error.message });
        }
    }
    async forgetPassword({ response, params }) {
        const secureId = params.id;
        let user;
        const trx = await Database_1.default.transaction();
        try {
            user = await User_1.default.findByOrFail('secure_id', secureId);
            const rememberMeToken = await Hash_1.default.make(user.cpf + (0, dayjs_1.default)().format());
            user.merge({ rememberMeToken: rememberMeToken }, trx).save();
        }
        catch (error) {
            trx.rollback();
            return response.badRequest({
                message: 'Error in generate token',
                originalError: error.message,
            });
        }
        try {
            await (0, sendMail_1.sendMail)(user, 'email/reset_password');
        }
        catch (error) {
            trx.rollback();
            return response.badRequest({ message: 'Error in send email', originalError: error.message });
        }
        trx.commit();
        return response.ok({ message: 'Success in send recovery email!' });
    }
    async resetPassword({ request, response }) {
        const data = await request.validate(ResetPasswordValidator_1.default);
        const trx = await Database_1.default.transaction();
        let user;
        try {
            user = await User_1.default.findByOrFail('remember_me_token', data.rememberMeToken);
            if (user.rememberMeToken === data.rememberMeToken) {
                user.merge(data.password).useTransaction(trx);
                await user.save();
            }
        }
        catch (error) {
            trx.rollback();
            return response.badRequest({
                message: 'Error in reset password',
                originalError: error.message,
            });
        }
        trx.commit();
        return response.ok({ message: 'Success in reset password' });
    }
    async AccessAllow({ response, request }) {
        await request.validate(AccessAllowValidator_1.default);
        const { userId, roles } = request.all();
        try {
            const userAllow = await User_1.default.findByOrFail('id', userId);
            let roleIds = [];
            await Promise.all(roles.map(async (roleName) => {
                const hasRole = await Role_1.default.findBy('name', roleName);
                if (hasRole)
                    roleIds.push(hasRole.id);
            }));
            await userAllow.related('roles').sync(roleIds);
        }
        catch (error) {
            return response.badRequest({ message: 'Error in access allow', originalError: error.message });
        }
        try {
            return User_1.default.query().where('id', userId).preload('roles').firstOrFail();
        }
        catch (error) {
            return response.badRequest({ message: 'Error in find user', originalError: error.message });
        }
    }
}
exports.default = UsersController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXNlcnNDb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVXNlcnNDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsa0ZBQXdDO0FBRXhDLDJGQUFpRDtBQUNqRCxpRkFBa0M7QUFDbEMsaUZBQWtDO0FBQ2xDLDBFQUFnRDtBQUNoRCxxSEFBc0U7QUFDdEUsbUhBQW9FO0FBQ3BFLHlIQUEwRTtBQUMxRSxtSEFBb0U7QUFDcEUsa0RBQXlCO0FBRXpCLE1BQXFCLGVBQWU7SUFDM0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQXVCO1FBQzNELE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQTtRQUVsRCxJQUFJLFVBQVUsRUFBRTtZQUNkLE9BQU8sY0FBSSxDQUFDLEtBQUssRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxTQUFTLEVBQUUsRUFBRTtnQkFDakQsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUE7WUFDaEMsQ0FBQyxDQUFDLENBQUE7U0FDSDtRQUVELElBQUk7WUFDRixNQUFNLEtBQUssR0FBRyxNQUFNLGNBQUksQ0FBQyxLQUFLLEVBQUU7aUJBQzdCLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxTQUFTLEVBQUUsRUFBRTtnQkFDOUIsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUE7WUFDaEMsQ0FBQyxDQUFDO2lCQUNELFFBQVEsQ0FBQyxJQUFJLElBQUksQ0FBQyxFQUFFLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FBQTtZQUVyQyxPQUFPLFFBQVEsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUE7U0FDMUI7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLE9BQU8sUUFBUSxDQUFDLFVBQVUsQ0FBQyxF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dkQsSUFBSSxPQUFPLEdBQWEsRUFBRSxDQUFBO1lBRTFCLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FDZixLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRTtnQkFDM0IsTUFBTSxPQUFPLEdBQUcsTUFBTSxjQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQTtnQkFDbkQsSUFBSSxPQUFPO29CQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ3ZDLENBQUMsQ0FBQyxDQUNILENBQUE7WUFFRCxNQUFNLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1NBQy9DO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxPQUFPLFFBQVEsQ0FBQyxVQUFVLENBQUMsRUFBRSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsYUFBYSxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFBO1NBQy9GO1FBRUQsSUFBSTtZQUNGLE9BQU8sY0FBSSxDQUFDLEtBQUssRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFBO1NBQ3ZFO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxPQUFPLFFBQVEsQ0FBQyxVQUFVLENBQUMsRUFBRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsYUFBYSxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFBO1NBQzVGO0lBQ0gsQ0FBQztDQUNGO0FBbk5ELGtDQW1OQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBIYXNoIGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSGFzaCdcbmltcG9ydCB0eXBlIHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSHR0cENvbnRleHQnXG5pbXBvcnQgRGF0YWJhc2UgZnJvbSAnQGlvYzpBZG9uaXMvTHVjaWQvRGF0YWJhc2UnXG5pbXBvcnQgUm9sZSBmcm9tICdBcHAvTW9kZWxzL1JvbGUnXG5pbXBvcnQgVXNlciBmcm9tICdBcHAvTW9kZWxzL1VzZXInXG5pbXBvcnQgeyBzZW5kTWFpbCB9IGZyb20gJ0FwcC9TZXJ2aWNlcy9zZW5kTWFpbCdcbmltcG9ydCBBY2Nlc3NBbGxvd1ZhbGlkYXRvciBmcm9tICdBcHAvVmFsaWRhdG9ycy9BY2Nlc3NBbGxvd1ZhbGlkYXRvcidcbmltcG9ydCBDcmVhdGVVc2VyVmFsaWRhdG9yIGZyb20gJ0FwcC9WYWxpZGF0b3JzL0NyZWF0ZVVzZXJWYWxpZGF0b3InXG5pbXBvcnQgUmVzZXRQYXNzd29yZFZhbGlkYXRvciBmcm9tICdBcHAvVmFsaWRhdG9ycy9SZXNldFBhc3N3b3JkVmFsaWRhdG9yJ1xuaW1wb3J0IFVwZGF0ZVVzZXJWYWxpZGF0b3IgZnJvbSAnQXBwL1ZhbGlkYXRvcnMvVXBkYXRlVXNlclZhbGlkYXRvcidcbmltcG9ydCBkYXlqcyBmcm9tICdkYXlqcydcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVXNlcnNDb250cm9sbGVyIHtcbiAgcHVibGljIGFzeW5jIGluZGV4KHsgcmVxdWVzdCwgcmVzcG9uc2UgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgIGNvbnN0IHsgcGFnZSwgcGVyUGFnZSwgbm9QYWdpbmF0ZSB9ID0gcmVxdWVzdC5xcygpXG5cbiAgICBpZiAobm9QYWdpbmF0ZSkge1xuICAgICAgcmV0dXJuIFVzZXIucXVlcnkoKS5wcmVsb2FkKCdyb2xlcycsIChyb2xlVGFibGUpID0+IHtcbiAgICAgICAgcm9sZVRhYmxlLnNlbGVjdCgnaWQnLCAnbmFtZScpXG4gICAgICB9KVxuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VycyA9IGF3YWl0IFVzZXIucXVlcnkoKVxuICAgICAgICAucHJlbG9hZCgncm9sZXMnLCAocm9sZVRhYmxlKSA9PiB7XG4gICAgICAgICAgcm9sZVRhYmxlLnNlbGVjdCgnaWQnLCAnbmFtZScpXG4gICAgICAgIH0pXG4gICAgICAgIC5wYWdpbmF0ZShwYWdlIHx8IDEsIHBlclBhZ2UgfHwgMTApXG5cbiAgICAgIHJldHVybiByZXNwb25zZS5vayh1c2VycylcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3QoeyBtZXNzYWdlOiAnRXJyb3IgaW4gbGlzdCB1c2VycycsIG9yaWdpbmFsRXJyb3I6IGVycm9yLm1lc3NhZ2UgfSlcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RvcmUoeyByZXNwb25zZSwgcmVxdWVzdCB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcXVlc3QudmFsaWRhdGUoQ3JlYXRlVXNlclZhbGlkYXRvcilcblxuICAgIGxldCB1c2VyXG5cbiAgICBjb25zdCB0cnggPSBhd2FpdCBEYXRhYmFzZS50cmFuc2FjdGlvbigpXG4gICAgdHJ5IHtcbiAgICAgIHVzZXIgPSBhd2FpdCBVc2VyLmNyZWF0ZShcbiAgICAgICAge1xuICAgICAgICAgIG5hbWU6IGRhdGEubmFtZSxcbiAgICAgICAgICBjcGY6IGRhdGEuY3BmLFxuICAgICAgICAgIGVtYWlsOiBkYXRhLmVtYWlsLFxuICAgICAgICAgIHBhc3N3b3JkOiBkYXRhLnBhc3N3b3JkLFxuICAgICAgICB9LFxuICAgICAgICB0cnhcbiAgICAgIClcblxuICAgICAgY29uc3Qgcm9sZVBsYXllciA9IGF3YWl0IFJvbGUuZmluZEJ5KCduYW1lJywgJ3BsYXllcicpXG5cbiAgICAgIGlmIChyb2xlUGxheWVyKSBhd2FpdCB1c2VyLnJlbGF0ZWQoJ3JvbGVzJykuYXR0YWNoKFtyb2xlUGxheWVyLmlkXSlcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdHJ4LnJvbGxiYWNrKClcbiAgICAgIHJldHVybiByZXNwb25zZS5iYWRSZXF1ZXN0KHsgbWVzc2FnZTogJ0Vycm9yIGluIGNyZWF0ZSB1c2VyJywgb3JpZ2luYWxFcnJvcjogZXJyb3IubWVzc2FnZSB9KVxuICAgIH1cblxuICAgIGxldCB1c2VyRmluZFxuICAgIHRyeSB7XG4gICAgICB1c2VyRmluZCA9IGF3YWl0IFVzZXIucXVlcnkoKS53aGVyZSgnaWQnLCB1c2VyLmlkKS5wcmVsb2FkKCdyb2xlcycpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRyeC5yb2xsYmFjaygpXG4gICAgICByZXR1cm4gcmVzcG9uc2UuYmFkUmVxdWVzdCh7IG1lc3NhZ2U6ICdFcnJvciBpbiBmaW5kIHVzZXInLCBvcmlnaW5hbEVycm9yOiBlcnJvci5tZXNzYWdlIH0pXG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHNlbmRNYWlsKHVzZXIsICdXZWxjb21lIHRvIHRoZSBCZXN0IExvdHRlcnkgU3lzdGVtIScsICdzZW5kX3dlbGNvbWVfZW1haWwnKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0cngucm9sbGJhY2soKVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3Qoe1xuICAgICAgICBtZXNzYWdlOiAnRXJyb3IgaW4gc2VuZCB3ZWxjb21lIGVtYWlsJyxcbiAgICAgICAgb3JpZ2luYWxFcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgdHJ4LmNvbW1pdCgpXG4gICAgcmV0dXJuIHJlc3BvbnNlLm9rKHsgdXNlckZpbmQgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzaG93KHsgcmVzcG9uc2UsIHBhcmFtcyB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgY29uc3QgdXNlclNlY3VyZUlkID0gcGFyYW1zLmlkXG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIucXVlcnkoKVxuICAgICAgICAud2hlcmUoJ3NlY3VyZV9pZCcsIHVzZXJTZWN1cmVJZClcbiAgICAgICAgLnByZWxvYWQoJ3JvbGVzJylcbiAgICAgICAgLnByZWxvYWQoJ2JldHMnLCAoYmV0KSA9PiB7XG4gICAgICAgICAgY29uc3QgY3VycmVudERhdGVMZXNzMzBkYXlzID0gZGF5anMoKS5zdWJ0cmFjdCgzMCwgJ2QnKS5mb3JtYXQoKVxuXG4gICAgICAgICAgYmV0LndoZXJlKCdjcmVhdGVkX2F0JywgJz4nLCBjdXJyZW50RGF0ZUxlc3MzMGRheXMpXG4gICAgICAgIH0pXG5cbiAgICAgIHJldHVybiByZXNwb25zZS5vayh1c2VyKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gcmVzcG9uc2Uubm90Rm91bmQoeyBtZXNzYWdlOiAnVXNlciBub3QgZm91bmQnLCBvcmlnaW5hbEVycm9yOiBlcnJvci5tZXNzYWdlIH0pXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZSh7IHJlcXVlc3QsIHJlc3BvbnNlLCBwYXJhbXMgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKFVwZGF0ZVVzZXJWYWxpZGF0b3IpXG5cbiAgICBjb25zdCB1c2VyU2VjdXJlSWQgPSBwYXJhbXMuaWRcblxuICAgIGxldCB1c2VyXG5cbiAgICBjb25zdCB0cnggPSBhd2FpdCBEYXRhYmFzZS50cmFuc2FjdGlvbigpXG5cbiAgICB0cnkge1xuICAgICAgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5T3JGYWlsKCdzZWN1cmVfaWQnLCB1c2VyU2VjdXJlSWQpXG4gICAgICB1c2VyLm1lcmdlKHsgbmFtZTogZGF0YS5uYW1lLCBjcGY6IGRhdGEuY3BmLCBlbWFpbDogZGF0YS5lbWFpbCB9LCB0cngpLnNhdmUoKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0cngucm9sbGJhY2soKVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3QoeyBtZXNzYWdlOiAnRXJyb3IgaW4gdXBkYXRlIHVzZXInLCBvcmlnaW5hbEVycm9yOiBlcnJvci5tZXNzYWdlIH0pXG4gICAgfVxuXG4gICAgbGV0IHVzZXJGaW5kXG4gICAgdHJ5IHtcbiAgICAgIHVzZXJGaW5kID0gYXdhaXQgVXNlci5xdWVyeSgpLndoZXJlKCdpZCcsIHVzZXIuaWQpLnByZWxvYWQoJ3JvbGVzJylcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdHJ4LnJvbGxiYWNrKClcbiAgICAgIHJldHVybiByZXNwb25zZS5iYWRSZXF1ZXN0KHsgbWVzc2FnZTogJ0Vycm9yIGluIGZpbmQgdXNlcicsIG9yaWdpbmFsRXJyb3I6IGVycm9yLm1lc3NhZ2UgfSlcbiAgICB9XG5cbiAgICB0cnguY29tbWl0KClcbiAgICByZXR1cm4gcmVzcG9uc2Uub2soeyB1c2VyRmluZCB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlc3Ryb3koeyByZXNwb25zZSwgcGFyYW1zIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCB1c2VyU2VjdXJlSWQgPSBwYXJhbXMuaWRcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlPckZhaWwoJ3NlY3VyZV9pZCcsIHVzZXJTZWN1cmVJZClcbiAgICAgIGF3YWl0IHVzZXIuZGVsZXRlKClcblxuICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKHsgbWVzc2FnZTogJ1N1Y2Nlc3MgaW4gZGVsZXRlIHVzZXInIH0pXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiByZXNwb25zZS5ub3RGb3VuZCh7IG1lc3NhZ2U6ICdVc2VyIG5vdCBmb3VuZCcsIG9yaWdpbmFsRXJyb3I6IGVycm9yLm1lc3NhZ2UgfSlcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZm9yZ2V0UGFzc3dvcmQoeyByZXNwb25zZSwgcGFyYW1zIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBjb25zdCBzZWN1cmVJZCA9IHBhcmFtcy5pZFxuXG4gICAgbGV0IHVzZXJcblxuICAgIGNvbnN0IHRyeCA9IGF3YWl0IERhdGFiYXNlLnRyYW5zYWN0aW9uKClcblxuICAgIHRyeSB7XG4gICAgICB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlPckZhaWwoJ3NlY3VyZV9pZCcsIHNlY3VyZUlkKVxuICAgICAgY29uc3QgcmVtZW1iZXJNZVRva2VuID0gYXdhaXQgSGFzaC5tYWtlKHVzZXIuY3BmICsgZGF5anMoKS5mb3JtYXQoKSlcbiAgICAgIHVzZXIubWVyZ2UoeyByZW1lbWJlck1lVG9rZW46IHJlbWVtYmVyTWVUb2tlbiB9LCB0cngpLnNhdmUoKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0cngucm9sbGJhY2soKVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3Qoe1xuICAgICAgICBtZXNzYWdlOiAnRXJyb3IgaW4gZ2VuZXJhdGUgdG9rZW4nLFxuICAgICAgICBvcmlnaW5hbEVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgfSlcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHNlbmRNYWlsKHVzZXIsICdlbWFpbC9yZXNldF9wYXNzd29yZCcpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRyeC5yb2xsYmFjaygpXG4gICAgICByZXR1cm4gcmVzcG9uc2UuYmFkUmVxdWVzdCh7IG1lc3NhZ2U6ICdFcnJvciBpbiBzZW5kIGVtYWlsJywgb3JpZ2luYWxFcnJvcjogZXJyb3IubWVzc2FnZSB9KVxuICAgIH1cblxuICAgIHRyeC5jb21taXQoKVxuICAgIHJldHVybiByZXNwb25zZS5vayh7IG1lc3NhZ2U6ICdTdWNjZXNzIGluIHNlbmQgcmVjb3ZlcnkgZW1haWwhJyB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlc2V0UGFzc3dvcmQoeyByZXF1ZXN0LCByZXNwb25zZSB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcXVlc3QudmFsaWRhdGUoUmVzZXRQYXNzd29yZFZhbGlkYXRvcilcblxuICAgIGNvbnN0IHRyeCA9IGF3YWl0IERhdGFiYXNlLnRyYW5zYWN0aW9uKClcbiAgICBsZXQgdXNlclxuICAgIHRyeSB7XG4gICAgICB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlPckZhaWwoJ3JlbWVtYmVyX21lX3Rva2VuJywgZGF0YS5yZW1lbWJlck1lVG9rZW4pXG4gICAgICBpZiAodXNlci5yZW1lbWJlck1lVG9rZW4gPT09IGRhdGEucmVtZW1iZXJNZVRva2VuKSB7XG4gICAgICAgIHVzZXIubWVyZ2UoZGF0YS5wYXNzd29yZCkudXNlVHJhbnNhY3Rpb24odHJ4KVxuICAgICAgICBhd2FpdCB1c2VyLnNhdmUoKVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0cngucm9sbGJhY2soKVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3Qoe1xuICAgICAgICBtZXNzYWdlOiAnRXJyb3IgaW4gcmVzZXQgcGFzc3dvcmQnLFxuICAgICAgICBvcmlnaW5hbEVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgfSlcbiAgICB9XG5cbiAgICB0cnguY29tbWl0KClcbiAgICByZXR1cm4gcmVzcG9uc2Uub2soeyBtZXNzYWdlOiAnU3VjY2VzcyBpbiByZXNldCBwYXNzd29yZCcgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBBY2Nlc3NBbGxvdyh7IHJlc3BvbnNlLCByZXF1ZXN0IH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKEFjY2Vzc0FsbG93VmFsaWRhdG9yKVxuXG4gICAgY29uc3QgeyB1c2VySWQsIHJvbGVzIH0gPSByZXF1ZXN0LmFsbCgpXG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlckFsbG93ID0gYXdhaXQgVXNlci5maW5kQnlPckZhaWwoJ2lkJywgdXNlcklkKVxuXG4gICAgICBsZXQgcm9sZUlkczogbnVtYmVyW10gPSBbXVxuXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgcm9sZXMubWFwKGFzeW5jIChyb2xlTmFtZSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGhhc1JvbGUgPSBhd2FpdCBSb2xlLmZpbmRCeSgnbmFtZScsIHJvbGVOYW1lKVxuICAgICAgICAgIGlmIChoYXNSb2xlKSByb2xlSWRzLnB1c2goaGFzUm9sZS5pZClcbiAgICAgICAgfSlcbiAgICAgIClcblxuICAgICAgYXdhaXQgdXNlckFsbG93LnJlbGF0ZWQoJ3JvbGVzJykuc3luYyhyb2xlSWRzKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gcmVzcG9uc2UuYmFkUmVxdWVzdCh7IG1lc3NhZ2U6ICdFcnJvciBpbiBhY2Nlc3MgYWxsb3cnLCBvcmlnaW5hbEVycm9yOiBlcnJvci5tZXNzYWdlIH0pXG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBVc2VyLnF1ZXJ5KCkud2hlcmUoJ2lkJywgdXNlcklkKS5wcmVsb2FkKCdyb2xlcycpLmZpcnN0T3JGYWlsKClcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3QoeyBtZXNzYWdlOiAnRXJyb3IgaW4gZmluZCB1c2VyJywgb3JpZ2luYWxFcnJvcjogZXJyb3IubWVzc2FnZSB9KVxuICAgIH1cbiAgfVxufVxuIl19